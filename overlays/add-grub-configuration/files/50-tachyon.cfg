# /etc/default/grub.d/50-tachyon.cfg
# Force correct root= and keep our console flags.
# Runs when grub-mkconfig/update-grub sources /etc/default/grub*.

# Find the UUID of the currently mounted root inside the chroot
ROOTDEV="$(findmnt -no SOURCE / 2>/dev/null || true)"
ROOTUUID="$(blkid -s UUID -o value "$ROOTDEV" 2>/dev/null || true)"

# Fallback: if that failed, try by label (your image labels the rootfs)
[ -z "$ROOTUUID" ] && ROOTUUID="$(blkid -s UUID -o value /dev/disk/by-label/desktop-rootfs 2>/dev/null || true)"

# If still empty, leave as-is to avoid breaking builds
if [ -n "$ROOTUUID" ]; then
  # Overwrite GRUB_CMDLINE_LINUX so any old root=/dev/loop1p1 is discarded
  GRUB_CMDLINE_LINUX="root=UUID=${ROOTUUID} rootfstype=ext4 rootwait console=ttyMSM0,115200n8 pcie_pme=nomsi earlycon"
else
  # Minimal fallback: strip any existing root=, then add rootwait + consoles
  CLEANED="$(printf ' %s ' "${GRUB_CMDLINE_LINUX:-}" | sed -E 's/[[:space:]]root=[^[:space:]]+//g;s/^[[:space:]]+|[[:space:]]+$//g')"
  GRUB_CMDLINE_LINUX="${CLEANED} rootwait console=ttyMSM0,115200n8 pcie_pme=nomsi earlycon"
fi

# Optional: keep defaults empty so everything lives in GRUB_CMDLINE_LINUX
GRUB_CMDLINE_LINUX_DEFAULT=""